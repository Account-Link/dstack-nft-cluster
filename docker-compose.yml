services:
  dstack-node:
    build: 
      context: .
      platforms:
        - linux/amd64
        - linux/arm64
    platform: linux/amd64
    environment:
      - CONTRACT_ADDRESS=${CONTRACT_ADDRESS:-0x9d22D844690ff89ea5e8a6bb4Ca3F7DAc83a40c3}
      - CONNECTION_URL=${CONNECTION_URL:-https://dstack-node.phala.network}
      - RPC_URL=${RPC_URL:-https://base.llamarpc.com}
      - DSTACK_SOCKET=${DSTACK_SOCKET:-/var/run/dstack.sock}
      - PRIVATE_KEY=${PRIVATE_KEY}
    volumes:
      # Mount DStack socket from host (Phala Cloud provides this)
      - /var/run/dstack.sock:/var/run/dstack.sock
      # Keep local simulator mount for development
      - ./simulator/dstack.sock:/app/simulator/dstack.sock
    ports:
      - "${NODE_PORT:-8080}:8080"
    # Add restart policy for production
    restart: unless-stopped
